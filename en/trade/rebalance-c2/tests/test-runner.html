<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shannon Strategy Test Runner</title>
    <link rel="stylesheet" href="test-report.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1>üß™ Shannon Strategy Test Runner</h1>
            <p>Comprehensive testing suite with code coverage analysis</p>
        </header>

        <section class="control-panel">
            <h2>Test Controls</h2>
            <div class="controls">
                <button id="runAllTests" class="btn btn-primary">
                    ‚ñ∂Ô∏è Run All Tests
                </button>
                <button id="runApiTests" class="btn btn-secondary">
                    üåê Run API Tests Only
                </button>
                <button id="runUnitTests" class="btn btn-secondary">
                    üîß Run Unit Tests Only
                </button>
                <button id="clearResults" class="btn btn-danger">
                    üóëÔ∏è Clear Results
                </button>
                <button id="exportReport" class="btn btn-info">
                    üì• Export Report
                </button>
            </div>
            
            <div class="test-options">
                <label>
                    <input type="checkbox" id="verboseMode" checked>
                    Verbose Mode (Show all details)
                </label>
                <label>
                    <input type="checkbox" id="stopOnFailure">
                    Stop on First Failure
                </label>
                <label>
                    <input type="checkbox" id="mockApiCalls" checked>
                    Mock External API Calls
                </label>
            </div>
        </section>

        <section class="status-panel" id="statusPanel" style="display: none;">
            <div class="status-message">
                <div class="spinner"></div>
                <span id="statusMessage">Initializing tests...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </section>

        <section id="reportContainer" class="report-container">
            <!-- Test results will be inserted here -->
        </section>
    </div>

    <!-- Load application code -->
    <script src="../app.js"></script>
    
    <!-- Load test framework and suite -->
    <script src="test-framework.js"></script>
    <script src="test-suite.js"></script>
    
    <script>
        // Test Runner Controller
        class TestRunnerController {
            constructor() {
                this.setupEventListeners();
                this.setupCoverage();
            }

            setupEventListeners() {
                document.getElementById('runAllTests').addEventListener('click', () => {
                    this.runTests('all');
                });

                document.getElementById('runApiTests').addEventListener('click', () => {
                    this.runTests('api');
                });

                document.getElementById('runUnitTests').addEventListener('click', () => {
                    this.runTests('unit');
                });

                document.getElementById('clearResults').addEventListener('click', () => {
                    this.clearResults();
                });

                document.getElementById('exportReport').addEventListener('click', () => {
                    this.exportReport();
                });
            }

            setupCoverage() {
                // Instrument application code for coverage
                if (typeof StockDataAPI !== 'undefined') {
                    testFramework.instrumentObject(StockDataAPI.prototype, 'StockDataAPI');
                }
                if (typeof ShannonStrategy !== 'undefined') {
                    testFramework.instrumentObject(ShannonStrategy.prototype, 'ShannonStrategy');
                }
                if (typeof ChartManager !== 'undefined') {
                    testFramework.instrumentObject(ChartManager.prototype, 'ChartManager');
                }
                if (typeof TableManager !== 'undefined') {
                    testFramework.instrumentObject(TableManager.prototype, 'TableManager');
                }
                if (typeof InputManager !== 'undefined') {
                    testFramework.instrumentObject(InputManager.prototype, 'InputManager');
                }
                if (typeof ComparisonDisplay !== 'undefined') {
                    testFramework.instrumentObject(ComparisonDisplay.prototype, 'ComparisonDisplay');
                }
            }

            async runTests(type) {
                this.showStatus('Running tests...');
                
                const verboseMode = document.getElementById('verboseMode').checked;
                const stopOnFailure = document.getElementById('stopOnFailure').checked;
                const mockApiCalls = document.getElementById('mockApiCalls').checked;

                // Configure test options
                if (mockApiCalls && typeof StockDataAPI !== 'undefined') {
                    // Override fetchRealData to always use mock
                    StockDataAPI.prototype.fetchRealData = async function(ticker, from, to) {
                        throw new Error('Using mock data');
                    };
                }

                // Filter tests based on type
                if (type === 'api') {
                    testFramework.suites = testFramework.suites.filter(s => s.name.includes('API'));
                } else if (type === 'unit') {
                    testFramework.suites = testFramework.suites.filter(s => !s.name.includes('API'));
                }

                try {
                    const report = await testFramework.run();
                    this.displayReport(report);
                    this.hideStatus();
                } catch (error) {
                    console.error('Test execution failed:', error);
                    this.showError(error.message);
                }
            }

            showStatus(message) {
                const statusPanel = document.getElementById('statusPanel');
                const statusMessage = document.getElementById('statusMessage');
                statusPanel.style.display = 'block';
                statusMessage.textContent = message;
            }

            hideStatus() {
                document.getElementById('statusPanel').style.display = 'none';
            }

            showError(message) {
                const reportContainer = document.getElementById('reportContainer');
                reportContainer.innerHTML = `
                    <div class="error-panel">
                        <h2>‚ùå Test Execution Failed</h2>
                        <p>${message}</p>
                    </div>
                `;
                this.hideStatus();
            }

            displayReport(report) {
                const reportContainer = document.getElementById('reportContainer');
                reportContainer.innerHTML = report.getHTML();
                
                // Add animations
                setTimeout(() => {
                    reportContainer.querySelectorAll('.test').forEach((el, i) => {
                        el.style.animation = `slideIn 0.3s ease ${i * 0.05}s both`;
                    });
                }, 100);
            }

            clearResults() {
                document.getElementById('reportContainer').innerHTML = '';
                // Reset test framework
                testFramework.results = [];
                testFramework.coverage.clear();
            }

            exportReport() {
                const reportContent = document.getElementById('reportContainer').innerHTML;
                if (!reportContent) {
                    alert('No report to export. Please run tests first.');
                    return;
                }

                const fullHtml = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Test Report - ${new Date().toISOString()}</title>
                        <style>${this.getExportStyles()}</style>
                    </head>
                    <body>
                        ${reportContent}
                    </body>
                    </html>
                `;

                const blob = new Blob([fullHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `test-report-${Date.now()}.html`;
                a.click();
                URL.revokeObjectURL(url);
            }

            getExportStyles() {
                // Include essential styles for exported report
                return `
                    body { font-family: -apple-system, sans-serif; padding: 20px; }
                    .test-report { max-width: 1200px; margin: 0 auto; }
                    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
                    .summary-card { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
                    .summary-card.success { background: #d4edda; color: #155724; }
                    .summary-card.failure { background: #f8d7da; color: #721c24; }
                    .coverage-green { background: #d4edda; color: #155724; }
                    .coverage-orange { background: #fff3cd; color: #856404; }
                    .coverage-red { background: #f8d7da; color: #721c24; }
                    .test.passed { background: #d4edda; padding: 10px; margin: 5px 0; border-radius: 5px; }
                    .test.failed { background: #f8d7da; padding: 10px; margin: 5px 0; border-radius: 5px; }
                    .coverage-bar { background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden; }
                    .coverage-fill { background: #4caf50; height: 100%; transition: width 0.3s; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                    .tested { background: #e8f5e9; }
                    .untested { background: #ffebee; }
                    pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
                `;
            }
        }

        // Initialize test runner when page loads
        window.addEventListener('DOMContentLoaded', () => {
            window.testRunner = new TestRunnerController();
            console.log('Test Runner initialized. Click "Run All Tests" to begin.');
        });
    </script>
</body>
</html>